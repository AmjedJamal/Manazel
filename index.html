<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>MANAZEL</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
    font-family: Arial;
    margin:20px;
    background:#f5f5f5;
    direction:rtl;
}
.container{
    max-width:1100px;
    margin:auto;
}
.logo{
    max-width: 200px;
    display: block;
    margin: auto 0 20px 0;
    margin-right: auto;
    border-radius: 5%;
}
.box{
    background:white;
    padding:21px;
    border:1px solid #ccc;
    border-radius:6px;
    margin-bottom:15px;
}
label{
    font-weight:bold;
    display:block;
    margin-top:10px;
}
input,textarea,select,button{
    padding:8px;
    margin:5px 0;
    width:100%;
}
button{
    background:#0077cc;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    background:white;
    direction:ltr; 
}
th,td{
    border:1px solid #777;
    padding:6px;
    text-align:center;
    font-size:14px;
}
th{background:#ddd;}
.project-row{
    background:#0033cc;
    color:white;
    font-weight:bold;
}
.step-row{background:#ccffcc;}
.hidden{display:none;}
.delete-btn{background:red;}
</style>
</head>
<body>

<div class="container">
<div id="inputPage">

<div class="box">
<h3>بيانات المشروع</h3>

<label>اسم العميل</label>
<input id="clientName">

<label>الموضوع</label>
<input id="subject">

<label>موقع المشروع</label>
<input id="projectLocation">

<label>تاريخ الإصدار</label>
<input type="date" id="issueDate">

<label>تاريخ بداية العمل</label>
<input type="date" id="startDate">

<label>تاريخ نهاية العمل</label>
<input type="date" id="endDate">

<label>المدة المتوقعة</label>
<input id="expectedDuration">

<label>رقم المشروع</label>
<input id="projectNumber">
</div>

<div class="box">
<h3>بيانات العمال</h3>

<label>عدد العمال</label>
<input id="workersCount">

<label>عدد الفنيين</label>
<input id="techniciansCount">

<label>عدد المشرفين</label>
<input id="supervisorsCount">

<label>أرقام التواصل</label>
<input id="contactNumbers">
</div>

<div class="box">
<h3>المواد والكميات</h3>
<label>كل مادة في سطر بالشكل التالي:</label>
<textarea id="materials" placeholder=" الاسم | الكمية | المدة | ملاحظات "></textarea>
</div>

<div class="box">
<h3>إضافة عمل زمني</h3>

<label>اسم العمل</label>
<input id="projectName">

<label>تاريخ بداية العمل</label>
<input type="date" id="projectStart">

<label>مدة العمل (عدد الأيام)</label>
<input type="number" id="projectDuration">

<button onclick="addProject()">إضافة عمل</button>

<hr>

<label>اختر العمل لإضافة خطوة له</label>
<select id="projectSelect">
<option value="" disabled selected>Select Activity</option>
</select>

<label>اسم الخطوة</label>
<input id="stepName">

<label>مدة الخطوة (عدد الأيام)</label>
<input type="number" id="stepDuration">

<button onclick="addStep()">إضافة خطوة</button>
</div>

<table>
<thead>
<tr>
<th>Activity ID</th>
<th>Activity Name</th>
<th>Original Duration (Days)</th>
<th>Start Date</th>
<th>Finish Date</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<button onclick="generateFinal()">عرض النتيجة النهائية</button>

</div>

<div id="finalPage" class="hidden"></div>

</div>

<script>

let projects=[];
let counter=1;

function formatDate(d){
    return d.toISOString().split("T")[0];
}

function addProject(){
    const name=projectName.value;
    const start=new Date(projectStart.value);
    const duration=parseInt(projectDuration.value);
    if(!name||!projectStart.value||!duration)return;

    const finish=new Date(start);
    finish.setDate(start.getDate()+duration);

    const id="A"+counter++;

    projects.push({id,name,start,finish,duration,steps:[]});
    
    updateSelect();
    render();

    // اختيار آخر عمل تلقائياً
    projectSelect.value = id;

    // تفريغ الحقول بعد الإضافة
    projectName.value="";
    projectStart.value="";
    projectDuration.value="";
}

function addStep(){
    const pid=projectSelect.value;
    const name=stepName.value;
    const duration=parseInt(stepDuration.value);
    if(!pid||!name||!duration)return;

    const p=projects.find(x=>x.id===pid);
    if(!p)return;

    let start;
    if(p.steps.length===0){
        start=new Date(p.start);
    }else{
        const lastStep=p.steps[p.steps.length-1];
        start=new Date(lastStep.finish);
    }

    const finish=new Date(start);
    finish.setDate(start.getDate()+duration);

    if(finish > p.finish){
        alert("Step duration exceeds project duration");
        return;
    }

    p.steps.push({
        id:pid+"-"+(p.steps.length+1),
        name,
        duration,
        start,
        finish
    });

    render();
}

function deleteStep(pid,index){
    const p=projects.find(x=>x.id===pid);
    p.steps.splice(index,1);

    let currentStart=new Date(p.start);
    p.steps.forEach(step=>{
        step.start=new Date(currentStart);
        step.finish=new Date(currentStart);
        step.finish.setDate(step.start.getDate()+step.duration);
        currentStart=new Date(step.finish);
    });

    render();
}

function updateSelect(){
    projectSelect.innerHTML='<option value="" disabled selected>Select Activity</option>';
    projects.forEach(p=>{
        projectSelect.innerHTML+=`<option value="${p.id}">${p.name}</option>`;
    });
}

function render(){
    tableBody.innerHTML="";
    projects.forEach(p=>{
        tableBody.innerHTML+=`
        <tr class="project-row">
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.duration}</td>
        <td>${formatDate(p.start)}</td>
        <td>${formatDate(p.finish)}</td>
        <td></td>
        </tr>`;

        p.steps.forEach((s,i)=>{
            tableBody.innerHTML+=`
            <tr class="step-row">
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.duration}</td>
            <td>${formatDate(s.start)}</td>
            <td>${formatDate(s.finish)}</td>
            <td><button class="delete-btn" onclick="deleteStep('${p.id}',${i})">Delete</button></td>
            </tr>`;
        });
    });
}

function generateFinal(){

document.getElementById("inputPage").classList.add("hidden");
const final=document.getElementById("finalPage");
final.classList.remove("hidden");

let html=`<img src="logo.jpg" alt="logo" class="logo">
<div class="box"><h3>بيانات المشروع</h3>
<p>العميل : ${clientName.value}</p>
<p>الموضوع : ${subject.value}</p>
<p>الموقع : ${projectLocation.value}</p>
<p>تاريخ الاصدار : ${issueDate.value}</p>
<p>بداية العمل : ${startDate.value}</p>
<p>نهاية العمل : ${endDate.value}</p>
<p>المدة المتوقعة : ${expectedDuration.value}</p>
<p>رقم المشروع : ${projectNumber.value}</p>
</div>`;

html+=`<div class="box"><h3>بيانات العمال</h3>
<p>عدد العمال : ${workersCount.value}</p>
<p>عدد الفنيين : ${techniciansCount.value}</p>
<p>عدد المشرفين : ${supervisorsCount.value}</p>
<p>ارقام التواصل : ${contactNumbers.value}</p>
</div>`;

html+=`<div class="box"><h3>المواد</h3><pre>${materials.value}</pre></div>`;
let materialsTable =`
<div class="box">
<h3>المواد</h3>
<table style="direction:rtl;">
<tr>
<th>اسم المادة</th>
<th>الكمية</th>
<th>المدة</th>
<th>ملاحظات</th>
</tr>`;
let lines =materials.value.split("\n");
lines.forEach(line=>{
    if(line.trim() !== ""){
        let cols = line.split("|");
        materialsTable += `
        <tr>
            <td>${cols[0] ? cols [0].trim() :
                ""}</td>
            <td>${cols[1] ? cols [1].trim() :
                ""}</td>
            <td>${cols[2] ? cols [2].trim() :
                ""}</td>
            <td>${cols[3] ? cols [3].trim() :
                ""}</td>
        </tr>`;
    }
});
materialsTable += `</table></div>`;
html += materialsTable;

html+=`<div class="box"><h3>الجدول الزمني</h3>
<table>
<tr>
<th>Activity ID</th>
<th>Activity Name</th>
<th>Original Duration (Days)</th>
<th>Start Date</th>
<th>Finish Date</th>
</tr>`;

projects.forEach(p=>{
html+=`<tr class="project-row">
<td>${p.id}</td><td>${p.name}</td><td>${p.duration}</td>
<td>${formatDate(p.start)}</td><td>${formatDate(p.finish)}</td>
</tr>`;
p.steps.forEach(s=>{
html+=`<tr>
<td>${s.id}</td><td>${s.name}</td><td>${s.duration}</td>
<td>${formatDate(s.start)}</td><td>${formatDate(s.finish)}</td>
</tr>`;
});
});

html+=`</table></div>
<button onclick="downloadPDF()">Download PDF</button>`;

final.innerHTML=html;
}

function downloadPDF(){
html2pdf().from(document.getElementById("finalPage")).save("MANAZEL_Project.pdf");
}

</script>
</body>
</html>
